<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>MOS Evaluation</title>

<style>
body {
  font-family: Arial, sans-serif;
  max-width: 1100px;
  margin: auto;
}

.stimulus {
  margin-bottom: 50px;
  padding-bottom: 30px;
  border-bottom: 1px solid #ccc;
}

label {
  display: block;
  margin: 4px 0;
}

button {
  font-size: 16px;
  padding: 12px 30px;
  margin: 30px 0;
}
</style>
</head>

<body>

<h2>Mean Opinion Score (MOS) Evaluation</h2>
<p>version1;Please watch each video with audio enabled and rate the overall quality.</p>

<div id="container"></div>

<button id="nextBtn">Next</button>

<script>
/********************************************************
 * CONFIGURATION
 ********************************************************/

const ITEMS_PER_PAGE = 5;

/* FIXED SYNTAX (commas added) */
const stimuli = [
  { id: "v01", file: "./samples/video/0_ts/v_00.mp4" },
  { id: "v02", file: "./samples/video/0_ts/v_01.mp4" },
  { id: "v03", file: "./samples/video/0_ts/v_02.mp4" },
  { id: "v04", file: "./samples/video/0_ts/v_03.mp4" },
  { id: "v05", file: "./samples/video/0_ts/v_04.mp4" },

  { id: "v06", file: "./samples/video/1_rms/v_00.mp4" },
  { id: "v07", file: "./samples/video/1_rms/v_01.mp4" },
  { id: "v08", file: "./samples/video/1_rms/v_02.mp4" },
  { id: "v09", file: "./samples/video/1_rms/v_03.mp4" },
  { id: "v10", file: "./samples/video/1_rms/v_04.mp4" }
];

/********************************************************
 * VARIABLES
 ********************************************************/

let trials = [];
let pageIndex = 0;
let results = [];

/********************************************************
 * FUNCTIONS
 ********************************************************/

function shuffle(array) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
}

/* participant-wise randomization */
if (sessionStorage.getItem("mos_trials")) {
  trials = JSON.parse(sessionStorage.getItem("mos_trials"));
} else {
  trials = stimuli.slice();
  shuffle(trials);
  sessionStorage.setItem("mos_trials", JSON.stringify(trials));
}

function loadPage() {
  const container = document.getElementById("container");
  container.innerHTML = "";

  const start = pageIndex * ITEMS_PER_PAGE;
  const current = trials.slice(start, start + ITEMS_PER_PAGE);

  current.forEach((t, idx) => {

    const block = document.createElement("div");
    block.className = "stimulus";

    const title = document.createElement("h4");
    title.textContent = `Stimulus ${start + idx + 1}`;
    block.appendChild(title);

    /* video */
    const video = document.createElement("video");
    video.width = 900;
    video.controls = true;

    const source = document.createElement("source");
    source.src = t.file;
    source.type = "video/mp4";

    video.appendChild(source);
    block.appendChild(video);

    /* MOS */
    const q = document.createElement("p");
    q.innerHTML = "<b>Overall perceived quality:</b>";
    block.appendChild(q);

    for (let score = 5; score >= 1; score--) {
      const label = document.createElement("label");

      const input = document.createElement("input");
      input.type = "radio";
      input.name = "mos_" + t.id;
      input.value = score;

      label.appendChild(input);
      label.appendChild(document.createTextNode(" " + score));

      block.appendChild(label);
    }

    container.appendChild(block);
  });
}

/********************************************************
 * NEXT BUTTON
 ********************************************************/

document.getElementById("nextBtn").onclick = function () {

  const start = pageIndex * ITEMS_PER_PAGE;
  const current = trials.slice(start, start + ITEMS_PER_PAGE);

  for (const t of current) {
    const selected = document.querySelector(
      `input[name="mos_${t.id}"]:checked`
    );

    if (!selected) {
      alert("Please rate all videos on this page.");
      return;
    }

    results.push({
      stimulus: t.id,
      mos: selected.value,
      page: pageIndex + 1
    });
  }

  pageIndex++;

  if (pageIndex * ITEMS_PER_PAGE < trials.length) {
    loadPage();
  } else {
    finish();
  }
};

/********************************************************
 * FINISH & DOWNLOAD
 ********************************************************/

function finish() {
  let csv = "stimulus,mos,page\n";

  results.forEach(r => {
    csv += `${r.stimulus},${r.mos},${r.page}\n`;
  });

  const blob = new Blob([csv], { type: "text/csv" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = "mos_results.csv";
  a.click();

  document.body.innerHTML = "<h2>Thank you for your participation.</h2>";
}

loadPage();
</script>

</body>
</html>
