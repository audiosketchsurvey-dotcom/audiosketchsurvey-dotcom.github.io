<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>MOS Evaluation</title>

<style>
body {
  font-family: Arial, sans-serif;
  max-width: 1000px;
  margin: auto;
}

.stimulus {
  margin-bottom: 50px;
  padding-bottom: 30px;
  border-bottom: 1px solid #ccc;
}

.mos label {
  display: block;
  margin: 4px 0;
}

button {
  font-size: 16px;
  padding: 12px 30px;
  margin: 30px 0;
}
</style>
</head>

<body>

<h2>Mean Opinion Score (MOS) Evaluation</h2>

<p>
version: 260129.01
Please watch each video <b>with audio enabled</b> and rate the overall quality.
</p>

<div id="container"></div>

<button id="nextBtn">Next</button>

<script>
/********************************************************
 * ✅ EDIT ONLY THIS PART
 ********************************************************/

const ITEMS_PER_PAGE = 5;

const stimuli = [
  { id: "v01", file: "./samples/video/0_ts/v_00.mp4" },
  { id: "v02", file: "./samples/video/0_ts/v_01.mp4" },
  { id: "v03", file: "./samples/video/0_ts/v_02.mp4" },
  { id: "v04", file: "./samples/video/0_ts/v_03.mp4" },
  { id: "v05", file: "./samples/video/0_ts/v_04.mp4" },
  { id: "v06", file: "./samples/video/1_rms/v_00.mp4" }
  { id: "v07", file: "./samples/video/1_rms/v_01.mp4" },
  { id: "v08", file: "./samples/video/1_rms/v_02.mp4" }
  { id: "v09", file: "./samples/video/1_rms/v_03.mp4" },
  { id: "v10", file: "./samples/video/1_rms/v_04.mp4" }
];

/********************************************************
 * internal logic
 ********************************************************/

let trials;
let page = 0;
let results = [];

/* shuffle */
function shuffle(a) {
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
}

/* participant-wise randomization */
if (sessionStorage.getItem("mos_trials")) {
  trials = JSON.parse(sessionStorage.getItem("mos_trials"));
} else {
  trials = [...stimuli];
  shuffle(trials);
  sessionStorage.setItem("mos_trials", JSON.stringify(trials));
}

function loadPage() {
  const container = document.getElementById("container");
  container.innerHTML = "";

  const start = page * ITEMS_PER_PAGE;
  const current = trials.slice(start, start + ITEMS_PER_PAGE);

  current.forEach((t, idx) => {

    const block = document.createElement("div");
    block.className = "stimulus";

    const title = document.createElement("h4");
    title.textContent = `Stimulus ${start + idx + 1}`;
    block.appendChild(title);

    /* ---------- video ---------- */
    const video = document.createElement("video");
    video.width = 800;
    video.controls = true;

    const source = document.createElement("source");
    source.src = t.file;
    source.type = "video/mp4";

    video.appendChild(source);
    block.appendChild(video);

    /* ---------- MOS ---------- */
    const mos = document.createElement("div");
    mos.className = "mos";

    mos.innerHTML = `
      <p><b>Overall quality:</b></p>
      <label><input type="radio" name="mos_${t.id}" value="5"> 5 – Excellent</label>
      <label><input type="radio" name="mos_${t.id}" value="4"> 4 – Good</label>
      <label><input type="radio" name="mos_${t.id}" value="3"> 3 – Fair</label>
      <label><input type="radio" name="mos_${t.id}" value="2"> 2 – Poor</label>
      <label><input type="radio" name="mos_${t.id}" value="1"> 1 – Bad</label>
    `;

    block.appendChild(mos);
    container.appendChild(block);
  });
}

document.getElementById("nextBtn").onclick = () => {

  const start = page * ITEMS_PER_PAGE;
  const current = trials.slice(start, start + ITEMS_PER_PAGE);

  for (const t of current) {
    const sel = document.querySelector(
      `input[name="mos_${t.id}"]:checked`
    );
    if (!sel) {
      alert("Please rate all videos on this page.");
      return;
    }

    results.push({
      stimulus: t.id,
      mos: sel.value,
      page: page + 1
    });
  }

  page++;

  if (page * ITEMS_PER_PAGE < trials.length) {
    loadPage();
  } else {
    finish();
  }
};

function finish() {
  const header = "stimulus,mos,page\n";
  const rows = results.map(r =>
    `${r.stimulus},${r.mos},${r.page}`
  ).join("\n");

  const blob = new Blob([header + rows], { type: "text/csv" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = "mos_results.csv";
  a.click();

  document.body.innerHTML =
    "<h2>Thank you for your participation.</h2>" +
    "<p>Results have been downloaded.</p>";
}

/* start */
loadPage();
</script>

</body>
</html>
